<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main}">
<head>
    <title>Détails de l'Incident - Street Incidents</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root {
            --primary-blue: #1e3a5f;
            --secondary-blue: #2c5282;
            --accent-blue: #3182ce;
            --gray-dark: #2d3748;
            --gray-medium: #4a5568;
            --gray-light: #e2e8f0;
        }

        .page-header {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--secondary-blue) 100%);
            color: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(49, 130, 206, 0.3);
        }

        .page-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .back-link {
            color: white;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .back-link:hover {
            gap: 12px;
            color: rgba(255, 255, 255, 0.9);
        }

        .details-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .detail-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .detail-card h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-dark);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--gray-light);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-row {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: var(--gray-medium);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-value {
            color: var(--gray-dark);
            font-size: 16px;
            font-weight: 500;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-block;
        }

        .status-badge.signale {
            background: #fef5e7;
            color: #d68910;
            border: 1px solid #f9e79f;
        }

        .status-badge.pris-en-charge {
            background: #ebf4ff;
            color: #5a67d8;
            border: 1px solid #c3dafe;
        }

        .status-badge.en-resolution {
            background: #d5f4e6;
            color: #1e8449;
            border: 1px solid #9ae6b4;
        }

        .status-badge.resolu {
            background: #ebf5fb;
            color: #2e86c1;
            border: 1px solid #bee3f8;
        }

        .status-badge.cloture {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #cbd5e0;
        }

        .priority-badge {
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }

        .priority-badge.haute {
            background: #fed7d7;
            color: #c53030;
        }

        .priority-badge.moyenne {
            background: #fefcbf;
            color: #d69e2e;
        }

        .priority-badge.basse {
            background: #c6f6d5;
            color: #2f855a;
        }

        .description-box {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            color: var(--gray-dark);
            line-height: 1.8;
            font-size: 15px;
        }

        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .photo-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-light);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 25px;
            padding-left: 20px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -35px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-blue);
            border: 3px solid white;
            box-shadow: 0 0 0 2px var(--accent-blue);
        }

        .timeline-item.current::before {
            background: #48bb78;
            box-shadow: 0 0 0 2px #48bb78;
        }

        .timeline-date {
            font-size: 13px;
            color: var(--gray-medium);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .timeline-status {
            font-weight: 600;
            color: var(--gray-dark);
            font-size: 15px;
        }

        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid var(--gray-light);
        }

        .map-placeholder {
            width: 100%;
            height: 300px;
            border-radius: 12px;
            background: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-medium);
            flex-direction: column;
            gap: 10px;
        }

        @media (max-width: 1024px) {
            .details-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .detail-card {
                padding: 20px;
            }

            .photos-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="page-header">
        <a th:href="@{/citizen/dashboard}" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Retour au Dashboard
        </a>
        <h2 th:text="${incident.titre}">Titre de l'incident</h2>
    </div>

    <div class="details-container">
        <!-- Main Details -->
        <div class="detail-card">
            <h3>
                <i class="fas fa-info-circle"></i>
                Informations de l'Incident
            </h3>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-hashtag"></i>
                    Numéro d'Incident
                </div>
                <div class="detail-value" th:text="'#' + ${incident.id}">#001</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-flag"></i>
                    Statut Actuel
                </div>
                <div class="detail-value">
                    <span class="status-badge"
                          th:classappend="${#strings.toLowerCase(incident.statut.name()).replace('_', '-')}"
                          th:text="${incident.statut.name() == 'SIGNALE'} ? 'Signalé' :
                                   (${incident.statut.name() == 'PRIS_EN_CHARGE'} ? 'Pris en Charge' :
                                   (${incident.statut.name() == 'EN_RESOLUTION'} ? 'En Résolution' :
                                   (${incident.statut.name() == 'RESOLU'} ? 'Résolu' : 'Clôturé')))">
                        Signalé
                    </span>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-exclamation-triangle"></i>
                    Priorité
                </div>
                <div class="detail-value">
                    <span class="priority-badge"
                          th:classappend="${incident.priorite.name() == 'HAUTE'} ? 'haute' : (${incident.priorite.name() == 'MOYENNE'} ? 'moyenne' : 'basse')"
                          th:text="${incident.priorite.name() == 'HAUTE'} ? 'Haute' : (${incident.priorite.name() == 'MOYENNE'} ? 'Moyenne' : 'Basse')">
                        Moyenne
                    </span>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-folder"></i>
                    Catégorie
                </div>
                <div class="detail-value" th:text="${incident.categorie}">Voirie</div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-map-marker-alt"></i>
                    Localisation
                </div>
                <div class="detail-value">
                    <span th:text="${incident.quartier != null ? incident.quartier.municipalite + ', ' + incident.quartier.gouvernorat : 'Non défini'}">
                        Tunis, Tunis Governorate
                    </span>
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-calendar-plus"></i>
                    Date de Création
                </div>
                <div class="detail-value"
                     th:text="${#temporals.format(incident.dateCreation, 'dd/MM/yyyy HH:mm')}">
                    01/01/2024 14:30
                </div>
            </div>

            <div class="detail-row" th:if="${incident.dateResolution != null}">
                <div class="detail-label">
                    <i class="fas fa-calendar-check"></i>
                    Date de Résolution
                </div>
                <div class="detail-value"
                     th:text="${#temporals.format(incident.dateResolution, 'dd/MM/yyyy HH:mm')}">
                    15/01/2024 10:00
                </div>
            </div>

            <div class="detail-row">
                <div class="detail-label">
                    <i class="fas fa-align-left"></i>
                    Description
                </div>
                <div class="description-box" th:text="${incident.description}">
                    Description détaillée de l'incident...
                </div>
            </div>


        </div>

        <!-- Sidebar -->
        <div>
            <!-- Status Timeline -->
            <div class="detail-card">
                <h3>
                    <i class="fas fa-history"></i>
                    Suivi de l'Incident
                </h3>

                <div class="timeline">
                    <div class="timeline-item"
                         th:classappend="${incident.statut.name() == 'SIGNALE'} ? 'current' : ''">
                        <div class="timeline-date"
                             th:text="${#temporals.format(incident.dateCreation, 'dd/MM/yyyy HH:mm')}">
                            01/01/2024 14:30
                        </div>
                        <div class="timeline-status">Incident Signalé</div>
                    </div>

                    <div class="timeline-item"
                         th:classappend="${incident.statut.name() == 'PRIS_EN_CHARGE'} ? 'current' : ''"
                         th:if="${incident.statut.ordinal() >= T(Street.Incidents.Project.Street.Incidents.Project.entities.Enums.StatutIncident).PRIS_EN_CHARGE.ordinal()}">
                        <div class="timeline-date">-</div>
                        <div class="timeline-status">Pris en Charge</div>
                    </div>

                    <div class="timeline-item"
                         th:classappend="${incident.statut.name() == 'EN_RESOLUTION'} ? 'current' : ''"
                         th:if="${incident.statut.ordinal() >= T(Street.Incidents.Project.Street.Incidents.Project.entities.Enums.StatutIncident).EN_RESOLUTION.ordinal()}">
                        <div class="timeline-date">-</div>
                        <div class="timeline-status">En Résolution</div>
                    </div>

                    <div class="timeline-item"
                         th:classappend="${incident.statut.name() == 'RESOLU'} ? 'current' : ''"
                         th:if="${incident.statut.ordinal() >= T(Street.Incidents.Project.Street.Incidents.Project.entities.Enums.StatutIncident).RESOLU.ordinal()}">
                        <div class="timeline-date"
                             th:text="${incident.dateResolution != null ? #temporals.format(incident.dateResolution, 'dd/MM/yyyy HH:mm') : '-'}">
                            15/01/2024 10:00
                        </div>
                        <div class="timeline-status">Résolu</div>
                    </div>

                    <div class="timeline-item"
                         th:classappend="${incident.statut.name() == 'CLOTURE'} ? 'current' : ''"
                         th:if="${incident.statut.ordinal() >= T(Street.Incidents.Project.Street.Incidents.Project.entities.Enums.StatutIncident).CLOTURE.ordinal()}">
                        <div class="timeline-date">-</div>
                        <div class="timeline-status">Clôturé</div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="detail-card" style="margin-top: 30px;">
                <h3>
                    <i class="fas fa-map"></i>
                    Localisation
                </h3>

                <div th:if="${incident.latitude != null and incident.longitude != null}">
                    <div id="detailMap" class="map-container"></div>
                </div>

                <div th:unless="${incident.latitude != null and incident.longitude != null}">
                    <div class="map-placeholder">
                        <i class="fas fa-map-marked-alt fa-3x"></i>
                        <p>Coordonnées GPS non disponibles</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Map Initialization Script -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            /*<![CDATA[*/
            var latitude = /*[[${incident.latitude}]]*/ null;
            var longitude = /*[[${incident.longitude}]]*/ null;
            /*]]>*/

            if (latitude && longitude) {
                // Parse coordinates (they're stored as strings)
                var lat = parseFloat(latitude);
                var lng = parseFloat(longitude);

                // Initialize map
                var map = L.map('detailMap').setView([lat, lng], 15);

                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                // Add marker
                var marker = L.marker([lat, lng]).addTo(map);

                // Optional: Add popup with incident title
                /*<![CDATA[*/
                var titre = /*[[${incident.titre}]]*/ 'Incident';
                /*]]>*/
                marker.bindPopup('<b>' + titre + '</b>').openPopup();
            }
        });
    </script>
</div>
</body>
</html>